{
  "id": "icrc-mapping-job",
  "sourceSettings": {
    "source": {
      "jsonClass": "SqlSourceSettings",
      "name": "icrc-db-source",
      "sourceUri": "https://datatools4heart.eu/data-ingestion-suite/icrc-data",
      "databaseUrl": "jdbc:postgresql://localhost:5432/dt4h_icrc_cdm",
      "username": "postgres",
      "password": "password"
    }
  },
  "sinkSettings": {
    "jsonClass": "FhirRepositorySinkSettings",
    "fhirRepoUrl": "http://localhost:8081/fhir",
    "errorHandling": "continue"
  },
  "mappingErrorHandling": "halt",
  "mappings": [
    {
      "mappingRef": "https://datatools4heart.eu/fhir/mappings/icrc/patient-mapping",
      "sourceContext": {
        "source": {
          "jsonClass": "SqlSource",
          "tableName": "patient.patient"
        }
      }
    },
    {
      "mappingRef": "https://datatools4heart.eu/fhir/mappings/icrc/encounter-mapping",
      "sourceContext": {
        "source": {
          "jsonClass": "SqlSource",
          "tableName": "patient.encounter"
        }
      }
    },
    {
      "mappingRef": "https://datatools4heart.eu/fhir/mappings/icrc/vital-sign-mapping",
      "sourceContext": {
        "source": {
          "jsonClass": "SqlSource",
          "tableName": "patient.encounter"
        }
      }
    },
    {
      "mappingRef": "https://datatools4heart.eu/fhir/mappings/icrc/lab-result-mapping",
      "sourceContext": {
        "labResults": {
          "jsonClass": "SqlSource",
          "query": "SELECT lh.exec_date, ld.id, ld.value, ld.unit, hc.lab_code, a.id_patient FROM lab.lab_data ld INNER JOIN lab.lab_header lh ON ld.id_lab_header = lh.id INNER JOIN lab.his_code hc ON ld.id_his_code = hc.id INNER JOIN patient.activity a ON a.id_activity = lh.id_activity"
        },
        "encounters": {
          "jsonClass": "SqlSource",
          "tableName": "patient.encounter"
        }
      }
    },
    {
      "mappingRef": "https://datatools4heart.eu/fhir/mappings/icrc/condition-mapping",
      "sourceContext": {
        "source": {
          "jsonClass": "SqlSource",
          "query": "SELECT d.id, d.id_patient, d.date_stamp, i.code_dot, i.name_english FROM patient.diagnose d INNER JOIN diagnose_dict.icd_10 i ON d.id_dict = i.id"
        }
      }
    },
    {
      "mappingRef": "https://datatools4heart.eu/fhir/mappings/icrc/medication-mapping",
      "sourceContext": {
        "medications": {
          "jsonClass": "SqlSource",
          "query": "SELECT m.id_patient_drug, m.id_patient, m.date_from, m.date_to, m.dose, dc.atc_who, dc.\"name\" FROM patient.medication m inner join drug_dict.drug_com dc ON m.id_drug = dc.id"
        },
        "encounters": {
          "jsonClass": "SqlSource",
          "tableName": "patient.encounter"
        }
      }
    },
    {
      "mappingRef": "https://datatools4heart.eu/fhir/mappings/icrc/procedure-mapping",
      "sourceContext": {
        "source": {
          "jsonClass": "SqlSource",
          "tableName": "patient.procedure_oper"
        }
      }
    },
    {
      "mappingRef": "https://datatools4heart.eu/fhir/mappings/icrc/electrocardiograph-mapping",
      "sourceContext": {
        "ecgs": {
          "jsonClass": "SqlSource",
          "query": "SELECT em.id, a.id_patient, em.date_exec, em.pr_duration, em.qrs_duration, em.qt, em.qtc, p_axis, qrs_axis, t_axis, inter_text FROM ecg.ecg_mortara em INNER JOIN patient.activity a ON em.id_activity = a.id_activity INNER JOIN (SELECT id_ecg, string_agg(nullif(inter_text, ''), ' || ') AS inter_text FROM ecg.mortara_interpret GROUP BY id_ecg) as mi ON em.id = mi.id_ecg"
        },
        "encounters": {
          "jsonClass": "SqlSource",
          "tableName": "patient.encounter"
        }
      }
    },
    {
      "mappingRef": "https://datatools4heart.eu/fhir/mappings/icrc/echocardiograph-mapping",
      "sourceContext": {
        "echos": {
          "jsonClass": "SqlSource",
          "query": "SELECT a.id_patient, a.\"time_stamp\", eb.* FROM echo.echo_basic eb INNER JOIN patient.activity a ON eb.id_activity = a.id_activity"
        },
        "encounters": {
          "jsonClass": "SqlSource",
          "tableName": "patient.encounter"
        }
      }
    },
    {
      "mappingRef": "https://datatools4heart.eu/fhir/mappings/icrc/symptom-mapping",
      "sourceContext": {
        "source": {
          "jsonClass": "SqlSource",
          "query": "SELECT s.id, s.id_symptom, e.id_patient, sd.\"name\", e.id_encounter, e.\"time_stamp\" FROM patient.symptom s, patient.symptom_dict sd, patient.encounter e WHERE s.id_symptom = sd.id AND s.id_encounter = e.id_encounter"
        }
      }
    },
    {
      "mappingRef": "https://datatools4heart.eu/fhir/mappings/icrc/smoking-status-mapping",
      "sourceContext": {
        "source": {
          "jsonClass": "SqlSource",
          "query": "SELECT id, id_patient, date_from, date_to, dose FROM patient.addiction a WHERE a.id_dict = 1"
        }
      }
    },
    {
      "mappingRef": "https://datatools4heart.eu/fhir/mappings/icrc/nyha-mapping",
      "sourceContext": {
        "source": {
          "jsonClass": "SqlSource",
          "query": "SELECT id_encounter, id_patient, nyha, time_stamp FROM patient.encounter"
        }
      }
    }
  ]
}
