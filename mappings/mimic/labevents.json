{
  "id" : "labevents",
  "url" : "https://mimic.mit.edu/fhir/mappings/labevents",
  "name" : "labevents",
  "title" : "Mapping of entries in 'labevents' table in MIMIC-IV v2.0 dataset into FHIR Observation resources",
  "source" : [ {
    "alias" : "source",
    "url" : "https://mimic.mit.edu/fhir/StructureDefinition/Ext-labevents",
    "joinOn" : [ ]
  } ],
  "context" : { },
  "variable" : [ ],
  "mapping" : [ {
    "expression" : {
      "name" : "labevents-mapping",
      "language" : "application/fhir-template+json",
      "value" : {
        "status" : "final",
        "category" : [ {
          "coding" : [ {
            "system" : "http://terminology.hl7.org/CodeSystem/observation-category",
            "code" : "laboratory",
            "display" : "Laboratory"
          } ]
        } ],
        "code" : {
          "coding" : [ "{{? trms:translateToCoding(itemid.toString(), 'https://mimic.mit.edu/fhir/CodeSystem/labitems','https://github.com/srdc/mimic-iv-to-fhir/fhir/ConceptMap/labitems-to-loinc')}}" ]
        },
        "effectiveDateTime" : "{{charttime.utl:toFhirDateTime('yyyy-MM-dd HH:mm:ss', '-05:00')}}",
        "valueQuantity" : {
          "{{#ifQuantity}}" : "{{iif(valuenum.exists() or (value.exists() and value.utl:isFhirQuantityExpression()), true, {})}}",
          "{{?}}": "{{utl:createFhirQuantity(valuenum.orElse(value), valueuom.trim(), 'http://unitsofmeasure.org', valueuom.trim())}}"
        },
        "specimen" : {
          "identifier" : {
            "system" : "{{%sourceSystem.sourceUri}}/fhir/specimen_ids",
            "value" : "{{specimen_id.toString()}}"
          }
        },
        "subject" : "{{mpp:createFhirReferenceWithHashedId('Patient', subject_id.toString())}}",
        "encounter" : "{{? mpp:createFhirReferenceWithHashedId('Encounter', hadm_id.toString())}}",
        "identifier" : [ {
          "use" : "official",
          "system" : "{{%sourceSystem.sourceUri}}/fhir/labevent_ids",
          "value" : "{{labevent_id.toString()}}"
        } ],
        "issued" : "{{? storetime.utl:toFhirDateTime('yyyy-MM-dd HH:mm:ss', '-05:00')}}",
        "interpretation" : {
          "{{#isAbnormal}}" : "{{iif(flag.exists() and flag='abnormal', true, {})}}",
          "{{*}}" : {
            "coding" : [ {
              "system" : "http://terminology.hl7.org/CodeSystem/v3-ObservationInterpretation",
              "code" : "A",
              "display" : "Abnormal"
            } ],
            "text" : "Abnormal"
          }
        },
        "note" : {
          "{{#note}}" : "{{comments}}",
          "{{*}}" : {
            "text" : "{{%note}}"
          }
        },
        "referenceRange" : {
          "{{#rrExists}}" : "{{iif(ref_range_lower.exists() and ref_range_upper.exists(), true, {})}}",
          "{{*}}" : {
            "low" : "{{utl:createFhirQuantity(ref_range_lower, valueuom.trim(), 'http://unitsofmeasure.org', valueuom.trim())}}",
            "high" : "{{utl:createFhirQuantity(ref_range_upper, valueuom.trim(), 'http://unitsofmeasure.org', valueuom.trim())}}"
          }
        },
        "id" : "{{mpp:getHashedId('Observation', labevent_id.toString())}}",
        "meta" : {
          "source" : "{{%sourceSystem.sourceUri}}",
          "profile" : [ "https://datatools4heart.eu/fhir/StructureDefinition/HFR-LabResult" ]
        },
        "extension" : {
          "{{#pr}}" : "{{priority}}",
          "{{*}}" : {
            "url" : "http://hl7.org/fhir/us/cdmh/StructureDefinition/cdmh-pcornet-lab-test-priority",
            "valueCode" : "{{iif(%pr='ROUTINE', 'R', iif(%pr='STAT', 'S', 'O'))}}"
          }
        },
        "resourceType" : "Observation"
      }
    },
    "precondition" : {
      "name" : "measuredValueExists",
      "language" : "text/fhirpath",
      "expression" : "valuenum.exists()"
    }
  } ]
}