{
  "id" : "omr",
  "url" : "https://mimic.mit.edu/fhir/mappings/omr",
  "name" : "omr",
  "title" : "Mapping of entries in 'omr' table in MIMIC-IV v2.0 dataset into FHIR Observation (Vital Sign profile) resources",
  "source" : [ {
    "alias" : "source",
    "url" : "https://mimic.mit.edu/fhir/StructureDefinition/Ext-omr",
    "joinOn" : [ ]
  } ],
  "context" : {
    "resultProfileMapping" : {
      "category" : "concept-map",
      "url" : "$CONTEXT_REPO/mimic/omr-result-name-map.csv"
    }
  },
  "variable" : [ ],
  "mapping" : [ {
    "expression" : {
      "name" : "omr-mapping",
      "language" : "application/fhir-template+json",
      "value" : {
        "category" : [ {
          "coding" : [ {
            "system" : "http://terminology.hl7.org/CodeSystem/observation-category",
            "code" : "{{iif(result_name = 'eGFR', 'laboratory', 'vital-signs')}}",
            "display" : "{{iif(result_name = 'eGFR', 'Laboratory', 'Vital Signs')}}"
          } ]
        } ],
        "code" : {
          "coding" : [ {
            "system" : "http://loinc.org",
            "code" : "{{mpp:getConcept(%resultProfileMapping, result_name, 'target_code')}}",
            "@sliceName" : "loincCode"
          } ],
          "text" : "{{result_name}}"
        },
        "effectiveDateTime" : "{{chartdate}}",
        "valueQuantity" : "{{utl:createFhirQuantity(result_value, 'http://unitsofmeasure.org', mpp:getConcept(%resultProfileMapping, result_name, 'target_unit'))}}",
        "subject" : "{{mpp:createFhirReferenceWithHashedId('Patient', subject_id.toString())}}",
        "status" : "final",
        "id" : "{{mpp:getHashedId('Observation', subject_id.toString() & chartdate.toString() & seq_num.toString() & result_name)}}",
        "meta" : {
          "source" : "{{%sourceSystem.sourceUri}}",
          "profile" : [ "https://datatools4heart.eu/fhir/StructureDefinition/HFR-VitalSign" ]
        },
        "extension" : [ {
          "url" : "http://hl7.org/fhir/StructureDefinition/observation-timeOffset",
          "valueInteger" : "{{seq_num}}"
        } ],
        "resourceType" : "Observation"
      }
    },
    "precondition" : {
      "name" : "isNotBloodPressure",
      "language" : "text/fhirpath",
      "expression" : "result_name.startsWith('Blood Pressure').not()"
    }
  }, {
    "expression" : {
      "name" : "bp-mapping",
      "language" : "application/fhir-template+json",
      "value" : {
        "{{#index}}" : "{{utl:indices(0, 1)}}",
        "{{*}}" : {
          "category" : [ {
            "coding" : [ {
              "system" : "http://terminology.hl7.org/CodeSystem/observation-category",
              "code" : "vital-signs",
              "display" : "Vital Signs"
            } ]
          } ],
          "code" : {
            "coding" : [ {
              "system" : "http://loinc.org",
              "code" : "{{ iif(%index = 0, '8480-6', '8462-4') }}",
              "@sliceName" : "loincCode"
            }, {
              "{{#sc}}" : "{{mpp:getConcept(%resultProfileMapping, result_name, 'secondary_code')}}",
              "{{?}}" : {
                "system" : "http://snomed.info/sct",
                "code" : "{{%sc}}"
              }
            } ],
            "text" : "{{result_name}}"
          },
          "effectiveDateTime" : "{{chartdate}}",
          "subject" : "{{mpp:createFhirReferenceWithHashedId('Patient', subject_id.toString())}}",
          "status" : "final",
          "valueQuantity" : {
            "value" : "{{result_value.utl:split('/')[%index].toDecimal()}}",
            "unit" : "mmHg",
            "system" : "http://unitsofmeasure.org",
            "code" : "mm[Hg]"
          },
          "id" : "{{mpp:getHashedId('Observation', subject_id.toString() & chartdate.toString() & seq_num.toString() & result_name)}}",
          "meta" : {
            "source" : "{{%sourceSystem.sourceUri}}",
            "profile" : [ "https://datatools4heart.eu/fhir/StructureDefinition/HFR-VitalSign" ]
          },
          "extension" : [ {
            "url" : "http://hl7.org/fhir/StructureDefinition/observation-timeOffset",
            "valueInteger" : "{{seq_num}}"
          } ],
          "resourceType" : "Observation"
        }
      }
    },
    "precondition" : {
      "name" : "isBloodPressure",
      "language" : "text/fhirpath",
      "expression" : "result_name.startsWith('Blood Pressure')"
    }
  } ]
}